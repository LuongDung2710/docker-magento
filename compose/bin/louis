# Color set
RED='\033[0;31m'
GREEN='\033[0;32m'
BGREEN='\033[1;32m'
BYELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'
CHECKMARK='\xE2\x9C\x94'
CROSS='\xE2\x9D\x8C'

DOMAIN=$1
SOURCE_FILE=$2
PROJECT=src
DB=$(ls $PROJECT/dbdump)

# Unzip source file to src folder
echo -e "${BGREEN} Unzip Source Code to src folder \n"
unzip $SOURCE_FILE -d $PROJECT
sleep 2

# Start container
echo -e "${BGREEN} Start Container \n"
bin/start --no-dev
echo -e "\n${BGREEN}Waiting for all containers to start up ...\n${NC}"
sleep 15

# Copy Global auth.json file and example env file
echo -e "${BGREEN} Init auth.json and env.php file \n"
cp ~/.composer/auth.json src
cp env.example.php src/app/etc/env.php

# Copy all file from host to container 
echo -e "${BGREEN} Copy all file from host to container"
bin/copytocontainer --all ## Initial copy will take a few minutes...

# Composer Install 
echo -e "${BGREEN} Composer Install"
bin/composer config --global --auth http-basic.repo.packagist.com louis.nguyen c01bbcb2c7cb0da26875b3075bece015a419ad301ae9878efae51b2b5fd4
bin/composer install

# Copy all file from container to host 
echo -e "${BGREEN} Copy all file from container to host"
bin/copyfromcontainer --all ## Initial copy will take a few minutes...

# Remove Definer for DB sql file and import
echo -e "${BGREEN} Import Database"
sed 's/\sDEFINER=`[^`]*`@`[^`]*`//g' -i src/dbdump/$DB
bin/mysql < src/dbdump/$DB

# Import config from app/etc/env.php and app/etc/config.env file
echo -e "${BGREEN} Import Config"
bin/magento app:config:import


# Create a DNS host entry and setup Magento base url
echo -e "${BGREEN} Set up Domain"

bin/setup-domain $DOMAIN
bin/magento config:set web/secure/base_url https://$DOMAIN/
bin/magento config:set web/unsecure/base_url https://$DOMAIN/
bin/magento config:set 	web/unsecure/base_link_url https://$DOMAIN/
bin/magento config:set 	web/secure/base_link_url https://$DOMAIN/
bin/magento config:set --scope=store --scope-code=admin web/secure/base_url https://$DOMAIN/
bin/magento config:set --scope=store --scope-code=admin web/unsecure/base_url https://$DOMAIN/
bin/magento config:set admin/url/custom https://$DOMAIN/